## Building up yml file for build

kind: pipeline
type: docker
name: Pull Request Checkerkind: pipeline
name: DH2 Project Build

platform:
  os: windows
  arch: amd64

clone:
    disable: true

platform:
  os: windows
  arch: amd64


steps:     
 - name: Remove DH2-CI Subfolders
   failure: ignore
   commands:
     - Start-Process powershell -Verb runAs
     - Remove-Item -path 'C:\DH2-CI\*' -Recurse -Force -EA SilentlyContinue
     
  
  
 - name: Clone Project
   commands:
     - cd C:\DH2-CI
     - git clone https://github.com/gatesfoundation/S-BI-Agile-DH2.git
     - cd C:\DH2-CI\S-BI-Agile-DH2
     - git checkout development
     
    
 - name: Start Project build
   failure: ignore
   commands:
     - Powershell.exe -File C:\DH2-CI\S-BI-Agile-DH2\BuildAndDeploy\Build\BuildSolution.ps1
     
     
 - name: Copy Binaries/Bits
   commands:
     - $baseFileName = "Master_EDW_Release_"
     - $dateAndTimeFormat = (Get-Date).ToString('yyyyMMdd_HH:mm:tt')
     - $ext = ".txt"
     - $masterFileName = "$baseFileName" + "" + $dateAndTimeFormat + "" +  "$ext"
     - echo $masterFileName
     - cd C:\DH2-CI\S-BI-Agile-DH2\BuildAndDeploy\TFS\Build
     - Powershell.exe -Command .\CopyBits.ps1 $masterFileName "C:\DH2-CI\Binaries\Master_EDW_Release_Version2012.txt" C:\DH2-CI\S-BI-Agile-DH2 C:\DH2-CI\Binaries
     
     
 - name: Generate Incremental Scripts (From Repo)
   commands:
     - cd C:\DH2-CI\S-BI-Agile-DH2\BuildAndDeploy\TFS\Build
     - Start-Process powershell -Verb runAs
     - Powershell.exe -Command .\GenerateINC.ps1 C:\DH2-CI\S-BI-Agile-DH2 C:\DH2-CI\Binaries  
     
     
 - name: Generate script for deployment (From SQL Server)
   commands:
     - Copy-Item "C:\IncrementalScripts\*" "C:\DH2-CI\Binaries\Release" -Force -Recurse
     - cd C:\DH2-CI\Binaries\Release
     - Start-Process powershell -Verb runAs
     - Powershell.exe -Command .\DeployEDW.ps1 DEV false false


 - name: Stop Existing Powershell Process
   failure: ignore
   commands:
     - taskkill /F /IM powershell.exe

      
     
node:
  keyA: DevBuildServer
    
    
trigger:
  branch:
    include:
    - development

steps:

# - name: Get Web Build Tools
  # image: mcr.microsoft.com/dotnet/core/sdk
  # commands:
  # - export PATH="$PATH:/root/.dotnet/tools"
  # - mkdir -p /usr/share/dotnet/sdk/3.1.408/Microsoft/VisualStudio/v16.0/WebApplications
  # - cp buildtools/Microsoft.WebApplication.targets /usr/share/dotnet/sdk/3.1.408/Microsoft/VisualStudio/v16.0/WebApplications
  # - dotnet --list-sdks
  # - wget https://packages.microsoft.com/config/debian/10/packages-microsoft-prod.deb -O packages-microsoft-prod.deb
  # - dpkg -i packages-microsoft-prod.deb
  # - apt-get update; 
  # - apt-get install -y apt-transport-https
  # - apt-get update
  # - apt-get install -y dotnet-sdk-5.0
  # - dotnet --list-sdks
  
  
  # - dotnet add LEAD/Scheduler/Scheduler.csproj package LEAD/Scheduler/packages.config
  # - dotnet add LEAD/Scheduler/Scheduler.csproj package NuGet.Frameworks --version 4.5.2 --package-directory /LEAD/packages
  # - dotnet tool install -g Microsoft.VisualStudio.Workload.WebBuildTools

# - name: Clean Project
  # image: nostradini/practice:mybuildtool    #mcr.microsoft.com/dotnet/sdk
  # commands:
  # - mkdir -p /usr/share/dotnet/sdk/5.0.202/Microsoft/VisualStudio/v16.0/WebApplications
  # - cp buildtools/Microsoft.WebApplication.targets /usr/share/dotnet/sdk/5.0.202/Microsoft/VisualStudio/v16.0/WebApplications
  # - dotnet clean LEAD/Scheduler/Scheduler.csproj

- name: Build Project
  image: nostradini/practice:latest   #nostradini/practice:mybuildtool    #mcr.microsoft.com/dotnet/sdk
  commands:
  - mkdir -p /usr/share/dotnet/sdk/5.0.202/Microsoft/VisualStudio/v16.0/WebApplications
  - cp buildtools/Microsoft.WebApplication.targets /usr/share/dotnet/sdk/5.0.202/Microsoft/VisualStudio/v16.0/WebApplications
  - ls -l /usr/share/dotnet/sdk/5.0.202
  - cd LEAD/Scheduler
  - dotnet --list-sdks
  - dotnet nuget restore
  - xbuild LEAD/Scheduler/Scheduler.csproj


trigger:
  branch:
      - gitlearning
  event:
    include:
      - pull_request
      - push
